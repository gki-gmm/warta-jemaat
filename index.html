<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warta Jemaat Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #e0e5ec;
            --primary-color: #3b82f6;
            --text-color: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Mencegah scroll body double */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Area Utama */
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #book-viewport {
            width: 100%;
            height: 90%; /* Sisakan ruang untuk kontrol bawah */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        /* Container Buku - Ukurannya akan diatur oleh JavaScript */
        #book {
            /* Penting: Transform-style untuk 3D flip */
            transform-style: preserve-3d;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .my-page {
            background-color: #fff;
            overflow: hidden;
            border: 1px solid #eee; 
        }

        /* Kover Hard Cover */
        .my-page[data-density="hard"] {
            background-color: #fdfdfd;
            border: 1px solid #ccc;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Navigasi */
        .nav-side {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #333;
            transition: all 0.2s;
            user-select: none;
        }

        .nav-side:hover { background: var(--primary-color); color: white; }
        .nav-left { left: 15px; }
        .nav-right { right: 15px; }

        /* Kontrol Bawah */
        .controls-bar {
            height: 10%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            border-top: 1px solid #ccc;
            z-index: 50;
        }

        .page-badge {
            font-weight: 500;
            color: #555;
        }

        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<!-- Loading -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#555;" id="loadingText">Memuat PDF...</div>
    <div style="margin-top:5px; font-size:12px; color:#888;" id="progressText">0%</div>
</div>

<div class="container">
    <!-- Nav -->
    <div class="nav-side nav-left" id="prevBtn">&#10094;</div>
    
    <!-- Viewport Buku -->
    <div id="book-viewport">
        <!-- Elemen #book akan diisi canvas oleh JS -->
        <div id="book"></div>
    </div>
    
    <div class="nav-side nav-right" id="nextBtn">&#10095;</div>
</div>

<!-- Footer Info -->
<div class="controls-bar">
    <div class="page-badge">
        Halaman <span id="pageInfo">0</span> / <span id="pageTotal">--</span>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
<script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>

<script>
    // --- KONFIGURASI ---
    // Gunakan URL ini untuk demo. Ganti ke file lokal Anda nanti.
    const currentPdfPath = 'WARTA JEMAAT GKI GMM EDISI 14 Tahun ke-22 (21-12-2025).pdf'; 
    
    // State
    let flipObject = null;
    let pdfDoc = null;
    let pdfRendered = false; // Flag agar tidak render ulang saat resize
    
    const elBook = document.getElementById('book');
    const pageInfo = document.getElementById('pageInfo');
    const pageTotal = document.getElementById('pageTotal');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loadingText');
    const progressText = document.getElementById('progressText');

    // 1. Inisialisasi Aplikasi
    async function initApp() {
        try {
            const loadingTask = pdfjsLib.getDocument(currentPdfPath);
            pdfDoc = await loadingTask.promise;
            pageTotal.innerText = pdfDoc.numPages;

            // RENDER PDF HANYA SEKALI
            await renderPdfToHtml();
            
            // Setup Ukuran & Flipbook Pertama Kali
            setupBookSizeAndFlipbook();

            // Hilangkan Loading
            loadingOverlay.style.opacity = 0;
            setTimeout(() => loadingOverlay.style.display = 'none', 500);

        } catch (err) {
            console.error(err);
            loadingText.innerText = "Error: Gagal muat PDF.";
            loadingText.style.color = "red";
        }
    }

    // 2. Render PDF menjadi Canvas (Hanya sekali di awal)
    async function renderPdfToHtml() {
        elBook.innerHTML = ''; // Bersihkan
        const fragment = document.createDocumentFragment();

        // Ambil halaman 1 untuk ambil rasio asli
        const firstPage = await pdfDoc.getPage(1);
        const viewport = firstPage.getViewport({ scale: 1.0 });
        
        // Simpan rasio asli (A4 biasanya ~1.414)
        window.aspectRatio = viewport.width / viewport.height; 
        window.baseRatio = { w: viewport.width, h: viewport.height };

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            // Update Loading Text
            progressText.innerText = Math.round((i / pdfDoc.numPages) * 100) + '%';

            const page = await pdfDoc.getPage(i);
            // Scale tinggi untuk kualitas tajam
            const v = page.getViewport({ scale: 2.0 });

            const div = document.createElement('div');
            div.className = 'my-page';
            
            // Set density (Penting untuk library)
            if (i === 1 || i === pdfDoc.numPages) {
                div.dataset.density = 'hard';
            } else {
                div.dataset.density = 'soft';
            }

            const canvas = document.createElement('canvas');
            canvas.width = v.width;
            canvas.height = v.height;

            await page.render({ canvasContext: canvas.getContext('2d'), viewport: v }).promise;
            
            div.appendChild(canvas);
            fragment.appendChild(div);
        }
        elBook.appendChild(fragment);
        pdfRendered = true;
    }

    // 3. Hitung Ukuran Buku (Responsive Logic)
    function calculateBookSize() {
        const viewportW = window.innerWidth;
        const viewportH = window.innerHeight;
        const isMobile = viewportW < 768; // Batas tablet/desktop

        let width, height;

        if (isMobile) {
            // Mode Portrait (HP): Tampilkan 1 Halaman penuh
            // Lebar buku = lebar layar - padding
            width = viewportW * 0.95; 
            // Tinggi = lebar / rasio (misal A4)
            height = width / window.aspectRatio;
            
            // Cek jika tinggi melebihi layar
            if (height > viewportH * 0.85) {
                height = viewportH * 0.85;
                width = height * window.aspectRatio;
            }
        } else {
            // Mode Landscape (PC/Tablet): Tampilkan 2 Halaman (Spread)
            // Tinggi buku = tinggi layar - padding
            height = viewportH * 0.8;
            // Lebar total (2 halaman) = (tinggi / rasio) * 2
            width = (height / window.aspectRatio) * 2;

            // Batasi lebar jika terlalu melebar
            if (width > viewportW * 0.9) {
                width = viewportW * 0.9;
                height = (width / 2) * window.aspectRatio;
            }
        }

        return { width, height, isMobile };
    }

    // 4. Setup Flipbook (Init & Re-Init)
    function setupBookSizeAndFlipbook() {
        if (!pdfRendered) return;

        const { width, height, isMobile } = calculateBookSize();

        // 1. Set Ukuran CSS Container #book
        // Ini penting agar library tahu area kerjanya
        elBook.style.width = `${width}px`;
        elBook.style.height = `${height}px`;

        // 2. Simpan halaman saat ini (jika ada instance lama)
        let currentIndex = 0;
        if (flipObject) {
            currentIndex = flipObject.getCurrentPageIndex();
            flipObject.destroy(); // Hancurkan instance lama bersih-bersih
        }

        // 3. Buat Instance Baru
        flipObject = new St.PageFlip(elBook, {
            width: width, // Base width (akan di-stretch)
            height: height, // Base height (akan di-stretch)
            size: "stretch", // Memaksa canvas menyesuaikan div container
            
            mode: isMobile ? "portrait" : "double", // Ganti mode otomatis
            showCover: true,
            mobileScrollSupport: true,
            maxShadowOpacity: 0.3,
            
            // Mulai dari halaman tersimpan sebelumnya (agar tidak reset saat zoom)
            startPage: currentIndex
        });

        // Load dari Elemen HTML yang SUDAH ADA (Tidak render ulang)
        flipObject.loadFromHTML(document.querySelectorAll('.my-page'));

        // Event Update Info Halaman
        flipObject.on('flip', (e) => {
            pageInfo.innerText = e.data + 1;
        });
    }

    // --- EVENT LISTENERS ---

    // Tombol Navigasi
    document.getElementById('prevBtn').onclick = () => { if(flipObject) flipObject.flipPrev(); };
    document.getElementById('nextBtn').onclick = () => { if(flipObject) flipObject.flipNext(); };

    // Resize & Zoom Handler (Debounced)
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            // Saat user zoom in/out, window.innerWidth berubah.
            // Kita panggil setup ulang. Karena pdfRendered = true, 
            // PDF tidak di-load ulang, hanya ukuran & mode flipbook yang disesuaikan.
            setupBookSizeAndFlipbook();
        }, 300);
    });

    // Mulai
    initApp();

</script>
</body>
</html>
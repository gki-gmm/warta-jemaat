<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warta Jemaat Online</title>
    
    <!-- Favicon dummy untuk menghilangkan error 404 di console -->
    <link rel="icon" href="data:,">

    <style>
        :root {
            --bg-color: #2c3e50;
            --paper-color: #fdfbf7;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #34495e 0%, #2c3e50 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            overflow: hidden;
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Container Buku */
        .book-container {
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #flipbook {
            display: none; /* Akan di-show via JS */
        }

        /* Styling Halaman */
        .page {
            background-color: var(--paper-color);
            overflow: hidden;
            border-left: 1px solid rgba(0,0,0,0.1); 
        }

        .page-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(to right, rgba(0,0,0,0.05) 0%, rgba(255,255,255,0) 10%, rgba(255,255,255,0) 90%, rgba(0,0,0,0.05) 100%);
        }

        .page img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Controls Navigasi */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .controls.active {
            opacity: 1;
            pointer-events: all;
        }

        .btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
        }

        #error-msg {
            display: none;
            text-align: center;
            color: #ff6b6b;
            padding: 20px;
            max-width: 400px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Memuat Buku...</div>
    </div>

    <!-- Error Message -->
    <div id="error-msg">
        <h3>File Tidak Ditemukan</h3>
        <p>Pastikan Anda memiliki file bernama <strong>WARTA JEMAAT GKI GMM EDISI 16 Tahun ke-22 (04-01-2026).pdf</strong> di folder yang sama dengan file HTML ini.</p>
    </div>

    <!-- Area Buku -->
    <div class="book-container">
        <div id="flipbook">
            <!-- Halaman akan digenerate otomatis -->
        </div>
    </div>

    <!-- Tombol Navigasi -->
    <div class="controls" id="controls">
        <button class="btn" onclick="prevPage()">&#10094;</button>
        <button class="btn" onclick="nextPage()">&#10095;</button>
    </div>

    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // --- KONFIGURASI ---
        const PDF_FILENAME = 'WARTA JEMAAT GKI GMM EDISI 16 Tahun ke-22 (04-01-2026).pdf';
        const SCALE_QUALITY = 1.5;
        
        // --- STATE ---
        let pdfDoc = null;
        let bookWidth = 0;
        let bookHeight = 0;
        let isMobile = window.innerWidth <= 768;

        // Setup Worker PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        $(document).ready(async function() {
            await loadPdf();
        });

        async function loadPdf() {
            try {
                const loadingTask = pdfjsLib.getDocument(PDF_FILENAME);
                pdfDoc = await loadingTask.promise;
                
                updateLoadingText(`Menemukan ${pdfDoc.numPages} halaman. Merender...`);
                
                await renderAllPages(pdfDoc);
                setupBook();
                
                $('#loading').fadeOut();
                $('#controls').addClass('active');

            } catch (error) {
                console.error(error);
                $('#loading').hide();
                $('#error-msg').show();
            }
        }

        async function renderAllPages(pdf) {
            const flipbook = $('#flipbook');
            flipbook.empty();
            
            const page1 = await pdf.getPage(1);
            const viewport = page1.getViewport({ scale: 1 }); // Ambil viewport natural dulu
            const aspectRatio = viewport.height / viewport.width;

            // Tentukan ukuran dasar
            if (isMobile) {
                bookWidth = window.innerWidth - 20; 
                bookHeight = bookWidth * aspectRatio;
            } else {
                bookWidth = 900; // Lebar tetap desktop
                bookHeight = bookWidth * (aspectRatio / 2); 
            }

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // Hitung scale untuk render gambar tajam
                const targetWidth = isMobile ? bookWidth : (bookWidth / 2);
                const scaleNeeded = (targetWidth * SCALE_QUALITY) / viewport.width;
                const newViewport = page.getViewport({ scale: scaleNeeded });

                canvas.height = newViewport.height;
                canvas.width = newViewport.width;

                await page.render({ canvasContext: context, viewport: newViewport }).promise;
                
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                
                const div = document.createElement('div');
                div.className = 'page';
                div.style.width = (isMobile ? bookWidth : (bookWidth / 2)) + 'px';
                div.style.height = bookHeight + 'px';
                
                const img = document.createElement('img');
                img.src = imgData;
                
                div.appendChild(img);
                flipbook.append(div);
                
                updateLoadingText(`Merender halaman ${i}/${pdf.numPages}...`);
            }
        }

        function setupBook() {
            const flipbook = $('#flipbook');
            
            // Pastikan bersih sebelum init ulang
            if (flipbook.data('turn')) {
                flipbook.turn("destroy");
                flipbook.turn("disable"); // Matikan interaksi sebentar
            }

            flipbook.turn({
                width: bookWidth,
                height: bookHeight,
                autoCenter: true, // Biarkan turn.js yang mengatur center
                duration: 1000,
                acceleration: true,
                gradients: true,
                elevation: 50,
                display: isMobile ? "single" : "double", // Set display langsung di awal
                when: {
                    turning: function(e, page, view) {
                        // console.log("Turning");
                    }
                }
            });
        }

        function updateLoadingText(msg) {
            $('#loading-text').text(msg);
        }

        window.prevPage = function() {
            $("#flipbook").turn("previous");
        }
        window.nextPage = function() {
            $("#flipbook").turn("next");
        }

        // Handle Resize
        let resizeTimeout;
        $(window).resize(function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 300);
        });

        function handleResize() {
            const newIsMobile = window.innerWidth <= 768;
            
            // Hanya reload jika mode berubah drastis (Mobile <-> Desktop)
            // Ini mencegah error "center is invalid value" saat resize kecil
            if (newIsMobile !== isMobile) {
                location.reload(); 
            }
            // Untuk resize kecil dalam mode yang sama, kita biarkan CSS centering bekerja
            // dan TIDAK memanggil fungsi turn("center") manual.
        }
    </script>
</body>
</html>